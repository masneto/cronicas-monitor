name: "Disparar workflow no Child"

on:
  workflow_call:
    inputs:
      input1:
        description: "Primeiro valor"
        required: true
        default: "abc"
        type: string
      input2:
        description: "Segundo valor"
        required: true
        default: "123"
        type: string
      input3:
        description: "VariÃ¡veis extras em JSON"
        required: true
        default: '{"var1":"teste1","var2":"teste2"}'
        type: string
    secrets:
      PAT_GITHUB_TOKEN:
        required: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      workflow-file: ${{ steps.prepare.outputs.workflow-file }}
      temp-branch: ${{ steps.prepare.outputs.temp-branch }}
    steps:
      - name: Checkout repo masneto/cronicas-monitor
        uses: actions/checkout@v4
        with:
          repository: masneto/cronicas-monitor
          ref: feature/teste-workflow
          token: ${{ secrets.PAT_GITHUB_TOKEN }}
          path: cronicas-monitor

      - name: Preparar workflow
        id: prepare
        uses: masneto/cronicas-actions/.github/actions/prepare-workflow@feature/add-wf-dispatcher
        with:
          source-file: "cronicas-monitor/python/python-workflow.yml"
          branch: ${{ github.ref_name }}
          token: ${{ secrets.PAT_GITHUB_TOKEN }}
          path: cronicas-monitor

  dispatch:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout repo masneto/cronicas-monitor
        uses: actions/checkout@v4
        with:
          repository: masneto/cronicas-monitor
          ref: ${{ needs.prepare.outputs.workflow-file }}
          token: ${{ secrets.PAT_GITHUB_TOKEN }}

      - name: Disparar workflow
        uses: masneto/cronicas-actions/.github/actions/dispatch-workflow@feature/add-wf-dispatcher
        with:
          workflow-file: ${{ needs.prepare.outputs.workflow-file }}
          branch: ${{ needs.prepare.outputs.temp-branch }}
          inputs-json: >-
            {
              "input1": "${{ inputs.input1 }}",
              "input2": "${{ inputs.input2 }}",
              "input3": ${{ inputs.input3 }}
            }
          token: ${{ secrets.PAT_GITHUB_TOKEN }}


      # - name: Trigger no Child Repo
      #   uses: masneto/cronicas-actions/.github/actions/prepare-and-dispatch-workflow@feature/add-wf-dispatcher
      #   with:
      #     source-file: "cronicas-monitor/python/python-workflow.yml"
      #     workflow-file: "teste.yml"
      #     branch: ${{ github.ref_name }}
      #     inputs-json: >-
      #       {
      #         "input1": "${{ inputs.input1 }}",
      #         "input2": "${{ inputs.input2 }}",
      #         "input3": ${{ inputs.input3 }}
      #       }
      #     token: ${{ secrets.PAT_GITHUB_TOKEN }}
